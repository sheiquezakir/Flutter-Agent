# Codemagic CI/CD Configuration
# Place this file at: app_root/codemagic.yaml

workflows:
  # Android Build Workflow
  android_release:
    name: Android Release Build
    triggering:
      events:
        - push
      branch:
        patterns:
          - pattern: main
            include: true
          - pattern: develop
            include: true
    environment:
      flutter: stable
      java: latest
      android_sdk: latest
    scripts:
      - name: Get Flutter dependencies
        script: |
          flutter pub get

      - name: Generate code (if needed)
        script: |
          flutter pub run build_runner build --delete-conflicting-outputs
        ignore_failures: true

      - name: Format and Analyze
        script: |
          dart format --line-length=100 lib/ test/ --set-exit-if-changed || true
          flutter analyze

      - name: Run tests
        script: |
          flutter test --no-test-assets

      - name: Build release APK
        script: |
          flutter build apk \
            --release \
            --obfuscate \
            --split-debug-info=build/symbols \
            --split-per-abi

      - name: Build app bundle
        script: |
          flutter build appbundle \
            --release \
            --obfuscate \
            --split-debug-info=build/symbols

    artifacts:
      - build/app/outputs/flutter-apk/**/*.apk
      - build/app/outputs/bundle/release/app-release.aab
      - build/symbols/**

    publishing:
      # Firebase App Distribution
      firebase:
        firebase_service_account: $FIREBASE_SERVICE_ACCOUNT
        android:
          app_id: com.example.app.debug
          groups:
            - qa-team
          release_notes: 'Build from commit $COMMIT_HASH'
        notify_testers: true
        always_notify_testers: false

      # Google Play Store (internal testing)
      google_play:
        credentials: $GOOGLE_PLAY_CREDENTIALS
        track: internal
        submit_as_draft: false

      # Slack notification
      slack:
        channel: '#flutter-builds'
        notify_on_build_start: true
        notify:
          success: true
          failure: true

  # iOS Build Workflow
  ios_release:
    name: iOS Release Build
    triggering:
      events:
        - push
      branch:
        patterns:
          - pattern: main
            include: true
    environment:
      flutter: stable
      xcode: latest
      cocoapods: default
    scripts:
      - name: Get Flutter dependencies
        script: |
          flutter pub get

      - name: Generate code
        script: |
          flutter pub run build_runner build --delete-conflicting-outputs
        ignore_failures: true

      - name: Run tests
        script: |
          flutter test

      - name: Build iOS app
        script: |
          flutter build ios \
            --release \
            --obfuscate \
            --split-debug-info=build/symbols

      - name: Archive app
        script: |
          cd ios
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -archivePath build/Runner.xcarchive \
            -allowProvisioningUpdates \
            archive

    artifacts:
      - build/ios/iphoneos/Runner.app
      - ios/build/Runner.xcarchive/**
      - build/symbols/**

    publishing:
      app_store_connect:
        api_key_id: $APPSTORE_KEY_ID
        issuer_id: $APPSTORE_ISSUER_ID
        key: $APPSTORE_PRIVATE_KEY
        submit_to_app_store: true
        beta_groups:
          - beta-testers

      slack:
        channel: '#ios-builds'
        notify_on_build_start: true
        notify:
          success: true
          failure: true

  # Full Release Workflow (Android + iOS)
  full_release:
    name: Full Platform Release
    triggering:
      events:
        - tag
      branch:
        patterns:
          - pattern: v*
            include: true
    environment:
      flutter: stable
    scripts:
      - name: Setup git
        script: |
          git config user.email "ci@example.com"
          git config user.name "CI Bot"

      - name: Get dependencies
        script: |
          flutter pub get

      - name: Run all tests
        script: |
          flutter test --coverage --no-test-assets

      - name: Build Android release bundle
        script: |
          flutter build appbundle \
            --release \
            --obfuscate \
            --split-debug-info=build/symbols

      - name: Build iOS app
        script: |
          flutter build ios \
            --release \
            --obfuscate \
            --split-debug-info=build/symbols \
            --no-codesign

    artifacts:
      - build/app/outputs/bundle/release/app-release.aab
      - build/ios/iphoneos/**
      - build/symbols/**
      - coverage/lcov.info

    publishing:
      # Publish to App Stores
      google_play:
        credentials: $GOOGLE_PLAY_CREDENTIALS
        track: production
        submit_as_draft: false

      app_store_connect:
        api_key_id: $APPSTORE_KEY_ID
        issuer_id: $APPSTORE_ISSUER_ID
        key: $APPSTORE_PRIVATE_KEY
        submit_to_app_store: true

      # GitHub release
      github_releases:
        authentication: $GITHUB_TOKEN
        prerelease: false
        artifact_patterns:
          - build/app/outputs/bundle/release/app-release.aab

      # Slack notification
      slack:
        channel: '#releases'
        notify_on_build_start: false
        notify:
          success: true
          failure: true

  # Nightly Build Workflow (Security scanning + testing)
  nightly_build:
    name: Nightly Build & Security Scan
    triggering:
      events:
        - schedule
      branch:
        patterns:
          - pattern: main
            include: true
      scheduling:
        interval: daily
        # Run at 2 AM UTC
        minute: 0
        hour: 2
    environment:
      flutter: stable
    scripts:
      - name: Get dependencies
        script: |
          flutter pub get

      - name: Run comprehensive tests
        script: |
          flutter test --coverage --verbose

      - name: Run security checks
        script: |
          # Check for hardcoded secrets
          echo "ğŸ” Checking for hardcoded secrets..."
          git grep -i 'password\|api.key\|secret' -- '*.dart' || true

          # Check dependencies
          echo "ğŸ” Checking dependencies for vulnerabilities..."
          flutter pub audit || true

      - name: Code quality checks
        script: |
          flutter analyze --verbose

      - name: Build release APK
        script: |
          flutter build apk --release

    artifacts:
      - build/app/outputs/flutter-apk/**/*.apk
      - coverage/lcov.info

    publishing:
      slack:
        channel: '#nightly-builds'
        notify:
          success: true
          failure: true

# Environment Variables Configuration
# Add these in Codemagic UI: Settings > Environment Variables

# Variables needed:
# - FIREBASE_SERVICE_ACCOUNT: Firebase service account JSON (base64 encoded)
# - GOOGLE_PLAY_CREDENTIALS: Google Play service account JSON (base64 encoded)
# - APPSTORE_KEY_ID: App Store Connect API key ID
# - APPSTORE_ISSUER_ID: App Store Connect issuer ID
# - APPSTORE_PRIVATE_KEY: App Store Connect private key (base64 encoded)
# - GITHUB_TOKEN: GitHub personal access token
# - SLACK_WEBHOOK: Slack webhook URL
# - SENTRY_DSN: Sentry project DSN (for crash reporting)

# To encode a file to base64:
# base64 -i credentials.json -o credentials.txt

# To use in workflow:
# echo $FIREBASE_SERVICE_ACCOUNT | base64 --decode > firebase-key.json
